<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Memorando de Di√°rias</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
      :root {
        --primary-color: #00f2ff;
        --secondary-color: #bc13fe;
        --action-color: #ff0055;
        --glass-bg: rgba(20, 20, 35, 0.90);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-color: #e0e0e0;
        --input-bg: rgba(0, 0, 0, 0.4);
        --success-color: #00ff88;
        --warning-color: #ffcc00;
        --error-color: #ff4d4d;
      }

      body {
        background: radial-gradient(circle at top, #1b2735 0%, #090a0f 100%);
        font-family: 'Roboto', sans-serif;
        color: var(--text-color);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .glass-container {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 30px;
        box-shadow: 0 0 40px rgba(0, 242, 255, 0.1);
        width: 100%;
        max-width: 950px;
        margin-top: 20px;
        position: relative;
      }

      /* Estiliza√ß√£o de Inputs, Selects e Datas */
      input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(1.5); 
        cursor: pointer; opacity: 0.8; transition: 0.3s;
      }
      input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; transform: scale(1.1); }

      /* Select Personalizado (Glass) */
      .glass-select {
        background: var(--input-bg);
        border: 1px solid var(--glass-border);
        color: #fff;
        padding: 12px;
        border-radius: 10px;
        width: 100%;
        font-family: 'Roboto';
        outline: none;
        cursor: pointer;
        appearance: none; /* Remove seta padr√£o */
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300f2ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 15px top 50%;
        background-size: 12px auto;
      }
      .glass-select option {
        background-color: #1b2735; /* Fundo escuro para as op√ß√µes */
        color: white;
      }
      .glass-select:focus { border-color: var(--primary-color); background-color: rgba(0,0,0,0.6); }

      .input-error {
        border: 2px solid var(--error-color) !important;
        box-shadow: 0 0 10px rgba(255, 77, 77, 0.5) !important;
        animation: shake 0.3s ease-in-out;
      }
      @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

      /* Modais */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
      .modal-content { background: #1b1b2f; border: 1px solid var(--primary-color); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0, 242, 255, 0.2); color: white; position: relative; animation: slideUp 0.3s ease; }
      @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
      .modal-title { font-family: 'Orbitron'; color: var(--primary-color); margin: 0; font-size: 1.2rem; }
      .btn-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
      .btn-close:hover { color: var(--error-color); transform: scale(1.1); }
      
      .alert-icon-box { text-align: center; margin-bottom: 15px; } .alert-icon-box i { font-size: 4rem; }
      .alert-message { text-align: center; font-size: 1rem; opacity: 0.9; margin-bottom: 25px; line-height: 1.5; }
      .btn-alert-ok { background: transparent; border: 2px solid; padding: 10px 40px; border-radius: 50px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; text-transform: uppercase; }
      .btn-alert-ok:hover { color: #000; box-shadow: 0 0 20px currentColor; background: currentColor; }

      .preview-list { list-style: none; padding: 0; margin: 0; } .preview-list li { margin-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 5px; display: flex; justify-content: space-between; }
      .preview-label { font-weight: bold; color: var(--primary-color); font-size: 0.85rem; } .preview-value { font-size: 0.95rem; color: white; text-align: right; }
      .profile-list { display: flex; flex-direction: column; gap: 10px; }
      .profile-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px; }
      .profile-card:hover { background: rgba(0, 242, 255, 0.1); border-color: var(--primary-color); }
      .profile-icon { font-size: 1.5rem; color: var(--primary-color); } .profile-info h4 { margin: 0; font-size: 1rem; color: white; } .profile-info p { margin: 3px 0 0 0; font-size: 0.8rem; color: rgba(255,255,255,0.5); }

      .nav-tabs { display: flex; gap: 15px; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
      .nav-btn { background: transparent; border: none; color: rgba(255,255,255,0.5); font-family: 'Orbitron'; font-size: 1rem; cursor: pointer; padding: 10px 20px; border-radius: 12px; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
      .nav-btn:hover { color: white; background: rgba(255,255,255,0.05); } .nav-btn.active { color: #0f0c29; background: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); font-weight: bold; }
      .tab-content { display: none; animation: fadeIn 0.4s ease; } .tab-content.active { display: block; }

      h2 { font-family: 'Orbitron'; color: var(--primary-color); text-align: center; margin-bottom: 20px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.4); text-transform: uppercase; line-height: 1.4; }
      .section-header { color: var(--primary-color); font-family: 'Orbitron'; font-size: 1rem; margin-top: 25px; border-left: 3px solid var(--primary-color); padding-left: 10px; margin-bottom: 15px; background: linear-gradient(90deg, rgba(0,242,255,0.1) 0%, transparent 100%); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center;}
      .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 15px; }
      .dates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border); }
      .dates-grid label { color: var(--primary-color); font-weight: bold; }
      label { font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 5px; display: block; }
      input, textarea { background: var(--input-bg); border: 1px solid var(--glass-border); color: #fff; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; font-family: 'Roboto'; transition: 0.3s; outline: none; }
      input:focus, textarea:focus { border-color: var(--primary-color); background: rgba(0,0,0,0.6); }

      .btn-neon { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); font-family: 'Orbitron'; font-weight: 700; text-transform: uppercase; width: 100%; padding: 18px; border-radius: 50px; cursor: pointer; transition: 0.3s; margin-top: 20px; }
      .btn-neon:hover:not(:disabled) { background: var(--primary-color); color: #000; box-shadow: 0 0 30px var(--primary-color); }
      .btn-neon:disabled { opacity: 0.5; cursor: wait; }
      .btn-confirm { background: var(--success-color); color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 15px; text-transform: uppercase; font-family: 'Orbitron'; }
      .btn-confirm:hover { box-shadow: 0 0 15px var(--success-color); transform: translateY(-2px); transition: 0.3s; }
      .btn-load { position: absolute; top: 25px; right: 30px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; gap: 8px; align-items: center; transition: 0.3s; }
      .btn-load:hover { background: rgba(255,255,255,0.15); border-color: var(--primary-color); }
      .btn-auto-num { background: transparent; border: 1px solid var(--action-color); color: var(--action-color); padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; font-family: 'Orbitron', sans-serif; display: flex; align-items: center; gap: 5px; }
      .btn-auto-num:hover:not(:disabled) { background: var(--action-color); color: white; box-shadow: 0 0 10px var(--action-color); }
      .btn-auto-num:disabled { opacity: 0.5; cursor: wait; }

      .format-selector { display: flex; gap: 10px; margin-top: 30px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 50px; border: 1px solid var(--glass-border); }
      .format-option { flex: 1; padding: 12px; text-align: center; border-radius: 50px; cursor: pointer; transition: 0.3s; font-weight: bold; color: rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: center; gap: 8px; }
      .format-option.active.pdf { background: #b30b00; color: white; box-shadow: 0 0 15px #b30b00; }
      .format-option.active.word { background: #2b579a; color: white; box-shadow: 0 0 15px #2b579a; }
      .diarias-control-panel { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: 1px solid var(--glass-border); }
      .range-container { position: relative; height: 40px; display: flex; align-items: center; margin: 20px 0; }
      input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; }
      input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary-color); cursor: pointer; box-shadow: 0 0 15px var(--primary-color); transition: transform 0.2s; margin-top: -9px; }
      .chips-container { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
      .chip { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-color); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; user-select: none; }
      .chip:hover { background: rgba(255,255,255,0.1); border-color: var(--primary-color); }
      .tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
      .tag-card { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
      .tag-card:hover { border-color: var(--secondary-color); background: rgba(255,255,255,0.06); }
      .tag-name { font-family: 'monospace'; color: var(--secondary-color); font-size: 1rem; }
      .tag-desc { font-size: 0.75rem; color: rgba(255,255,255,0.5); display: block; margin-top: 4px; }
      .btn-copy { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; padding: 5px 10px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
      .btn-copy:hover { background: white; color: black; }
      #statusBox { display: none; margin-top: 20px; padding: 15px; border-radius: 12px; text-align: center; }
    </style>
  </head>
  <body>

    <div id="modalAlerta" class="modal-overlay">
      <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div class="alert-icon-box"><i id="alertaIcone" class="bi"></i></div>
        <h3 id="alertaTitulo" class="modal-title" style="margin-bottom: 10px; font-size: 1.4rem;"></h3>
        <p id="alertaMensagem" class="alert-message"></p>
        <button id="alertaBtn" class="btn-alert-ok" onclick="fecharModal('modalAlerta')">ENTENDIDO</button>
      </div>
    </div>

    <div id="modalPerfis" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3 class="modal-title"><i class="bi bi-people"></i> MEUS PERFIS</h3><button class="btn-close" onclick="fecharModal('modalPerfis')">&times;</button></div>
        <div id="listaPerfis" class="profile-list"><p style="text-align:center; opacity:0.6;">Carregando...</p></div>
      </div>
    </div>

    <div id="modalPreview" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3 class="modal-title"><i class="bi bi-eye"></i> CONFIRMAR DADOS</h3><button class="btn-close" onclick="fecharModal('modalPreview')">&times;</button></div>
        <ul id="listaPreview" class="preview-list"></ul>
        <button class="btn-confirm" onclick="enviarParaBackend()"><i class="bi bi-check-lg"></i> Confirmar e Gerar</button>
      </div>
    </div>

    <div class="glass-container">
      <button type="button" class="btn-load" onclick="abrirModalPerfis()"><i class="bi bi-person-lines-fill"></i> Meus Perfis</button>
      <div class="nav-tabs"><button class="nav-btn active" onclick="switchTab('gerador')"><i class="bi bi-lightning-charge"></i> Gerador</button><button class="nav-btn" onclick="switchTab('tags')"><i class="bi bi-tags"></i> Mapa de Tags</button></div>

      <div id="tab-gerador" class="tab-content active">
        <h2>Gerador de Memorando de Di√°rias <span style="font-size: 0.6em; vertical-align: super; opacity: 0.8; color:white;">V13.0</span></h2>
        <form id="formSmart" onsubmit="validarEProcessar(event)">
          <div class="section-header"><i class="bi bi-person-circle"></i> IDENTIFICA√á√ÉO</div>
          <div class="grid-row"><div><label>Nome do Servidor</label><input type="text" name="nome" id="campoNome" required placeholder="Nome completo..."></div><div><label>Cargo</label><input type="text" name="cargo" id="campoCargo" placeholder="Ex: Controlador"></div></div>
          <div><label>Dados Banc√°rios</label><input type="text" name="banco" id="campoBanco" required placeholder="Banco, Ag√™ncia, Conta, Pix..."></div>

          <div class="section-header"><i class="bi bi-airplane"></i> DADOS DA VIAGEM</div>
          <div style="margin-bottom: 20px;"><label>Motivo / Evento</label><textarea name="motivo" id="campoMotivo" rows="2" required placeholder="Participa√ß√£o no curso..."></textarea></div>
          
          <!-- NOVO: DESTINO DIVIDIDO -->
          <div class="grid-row" style="grid-template-columns: 3fr 1fr;">
            <div>
               <label>Cidade</label>
               <input type="text" id="inputCidade" placeholder="Digite a cidade..." required oninput="atualizarDestino()">
            </div>
            <div>
               <label>UF</label>
               <select id="selectUF" required onchange="atualizarDestino()" class="glass-select">
                 <option value="" disabled selected>UF</option>
                 <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option><option value="AM">AM</option>
                 <option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option>
                 <option value="GO">GO</option><option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                 <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option><option value="PR">PR</option>
                 <option value="PE">PE</option><option value="PI">PI</option><option value="RJ">RJ</option><option value="RN">RN</option>
                 <option value="RS">RS</option><option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                 <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
               </select>
            </div>
          </div>
          <!-- Campo oculto que recebe "Cidade/UF" para enviar ao backend -->
          <input type="hidden" name="destino" id="campoDestino">

          <div class="diarias-control-panel"><label style="color: var(--primary-color); font-weight:bold; margin-bottom:10px;">Quantidade de Di√°rias</label><div class="chips-container"><div class="chip" onclick="setDiaria(0.5, 'uma meia di√°ria')">¬Ω Meia</div><div class="chip" onclick="setDiaria(1.0, 'uma di√°ria')">1 Di√°ria</div><div class="chip" onclick="setDiaria(1.5, 'uma di√°ria e meia')">1.5</div><div class="chip" onclick="setDiaria(2.0, 'duas di√°rias')">2 Di√°rias</div><div class="chip" onclick="setDiaria(2.5, 'duas di√°rias e meia')">2.5</div><div class="chip" onclick="setDiaria('duas meias di√°rias', 'duas meias di√°rias', true)">2x Meias</div></div><div class="range-container"><input type="range" min="0.5" max="5.0" step="0.5" value="1.0" id="sliderDiarias" oninput="updateSlider(this.value)"></div><input type="text" name="qtdDiarias" id="qtdDiariasInput" required placeholder="Arraste a barra ou digite..." style="font-weight: bold; color: var(--primary-color); border-color: var(--primary-color);"></div>

          <div class="grid-row" style="margin-top:20px;"><div><label style="color: var(--success-color);">üìÖ In√≠cio do Evento</label><input type="date" name="dataInicio" id="dataInicio" required onchange="sincronizarAfastamento()"></div><div><label style="color: var(--success-color);">üìÖ Fim do Evento</label><input type="date" name="dataFim" id="dataFim" required onchange="sincronizarAfastamento()"></div></div>
          <div style="background: rgba(255,204,0,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,204,0,0.2); margin-top: 15px;"><label style="color: var(--warning-color); font-weight:bold;"><i class="bi bi-car-front-fill"></i> PER√çODO DE AFASTAMENTO</label><div class="grid-row" style="margin-bottom: 0;"><div><label>Sa√≠da</label><input type="date" id="afastInicio" onchange="calcularTextoAfastamento()"></div><div><label>Retorno</label><input type="date" id="afastFim" onchange="calcularTextoAfastamento()"></div></div><input type="hidden" name="dataAfastamento" id="dataAfastamentoHidden"><div style="margin-top:10px; font-family:monospace; color:var(--warning-color); font-size:0.9rem;">Texto: <span id="previewAfastamento">---</span></div></div>

          <div class="section-header"><i class="bi bi-wallet2"></i> VALORES</div>
          <div class="grid-row"><div><label>Valor (R$)</label><input type="number" step="0.01" name="valor" id="campoValor" required placeholder="0.00"></div><div style="display:flex; align-items:center; opacity:0.7; font-size:0.9rem;"><i class="bi bi-magic" style="margin-right:8px;"></i> Extenso autom√°tico.</div></div>

          <div class="section-header"><div><i class="bi bi-pen"></i> ASSINATURAS</div><button type="button" class="btn-auto-num" onclick="solicitarNumeracao()" id="btnAutoNum"><i class="bi bi-robot"></i> Gerar Numera√ß√£o</button></div>
          <div class="dates-grid"><div><label>Memo 1</label><input type="text" name="numMemo1" id="numMemo1" placeholder="Ex: 317/2025" style="margin-bottom:5px;" required><input type="date" name="dataMemo1" id="dataMemo1" onchange="replicarDataMemo()" title="Data de Assinatura do Memo 1" required></div><div><label>Memo 2</label><input type="text" name="numMemo2" id="numMemo2" placeholder="N√∫mero"><input type="date" name="dataMemo2" id="dataMemo2"></div><div><label>Memo 3</label><input type="text" name="numMemo3" id="numMemo3" placeholder="N√∫mero"><input type="date" name="dataMemo3" id="dataMemo3"></div><div><label>Memo 4</label><input type="text" name="numMemo4" id="numMemo4" placeholder="N√∫mero"><input type="date" name="dataMemo4" id="dataMemo4"></div></div>
          <div style="margin-top:15px;"><label>Data do Despacho</label><input type="date" name="dataDespacho" id="dataDespacho" required></div>

          <div class="section-header" style="border-left-color: white;"><i class="bi bi-filetype-doc"></i> FORMATO FINAL</div>
          <div class="format-selector"><div class="format-option active pdf" id="optPdf" onclick="setFormato('pdf')"><i class="bi bi-file-pdf"></i> PDF</div><div class="format-option" id="optDocx" onclick="setFormato('docx')"><i class="bi bi-file-word"></i> Word</div></div>
          <input type="hidden" name="formato" id="formatoInput" value="pdf">

          <button type="submit" id="btnEnviar" class="btn-neon"><i class="bi bi-cpu"></i> PR√â-VISUALIZAR</button>
        </form>
        <div id="statusBox"></div>
      </div>

      <!-- ABA 2: MAPA DE TAGS -->
      <div id="tab-tags" class="tab-content">
        <h2>MAPA DE TAGS</h2>
        <div class="tags-grid">
          <div class="tag-card"><div><span class="tag-name">{{NOME_SOLICITANTE}}</span></div><button class="btn-copy" onclick="copyTag('{{NOME_SOLICITANTE}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{QTD_DIARIAS}}</span></div><button class="btn-copy" onclick="copyTag('{{QTD_DIARIAS}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{VALOR}}</span></div><button class="btn-copy" onclick="copyTag('{{VALOR}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{VALOREXTENSO}}</span></div><button class="btn-copy" onclick="copyTag('{{VALOREXTENSO}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{DESTINO}}</span></div><button class="btn-copy" onclick="copyTag('{{DESTINO}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{EVENTO}}</span></div><button class="btn-copy" onclick="copyTag('{{EVENTO}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{DATADOEVENTO}}</span></div><button class="btn-copy" onclick="copyTag('{{DATADOEVENTO}}')"><i class="bi bi-clipboard"></i></button></div>
           <div class="tag-card"><div><span class="tag-name">{{DATADOAFASTAMENTO}}</span></div><button class="btn-copy" onclick="copyTag('{{DATADOAFASTAMENTO}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{DADOS_BANCARIOS}}</span></div><button class="btn-copy" onclick="copyTag('{{DADOS_BANCARIOS}}')"><i class="bi bi-clipboard"></i></button></div>
           <div class="tag-card"><div><span class="tag-name">{{NUM_MEMO1}}</span></div><button class="btn-copy" onclick="copyTag('{{NUM_MEMO1}}')"><i class="bi bi-clipboard"></i></button></div>
           <div class="tag-card"><div><span class="tag-name">{{DATADOMEMO1}}</span></div><button class="btn-copy" onclick="copyTag('{{DATADOMEMO1}}')"><i class="bi bi-clipboard"></i></button></div>
          <div class="tag-card"><div><span class="tag-name">{{CARGO}}</span></div><button class="btn-copy" onclick="copyTag('{{CARGO}}')"><i class="bi bi-clipboard"></i></button></div>
        </div>
      </div>

    </div>

    <script>
      // CONFIGURA√á√ÉO DA API
      const API_URL = "https://script.google.com/macros/s/AKfycbwcnaHCfwuunN5TNdFyLF_2khPmqZS5gs_ZgiMo7cpPgmDm1nQTaoOAtPnnkDuQuRXc/exec"; 

      // Atualiza o campo oculto 'destino'
      function atualizarDestino() {
        const cidade = document.getElementById('inputCidade').value;
        const uf = document.getElementById('selectUF').value;
        document.getElementById('campoDestino').value = cidade && uf ? `${cidade}/${uf}` : '';
      }

      // SISTEMA DE RETRY
      async function apiCall(action, payload = {}) {
        const MAX_RETRIES = 3;
        const btn = document.querySelector('.btn-load') || document.getElementById('btnEnviar');
        const originalText = btn ? btn.innerHTML : '';
        for (let i = 0; i < MAX_RETRIES; i++) {
          try {
            if (i > 0 && btn) btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Acordando servidor... (${i+1}/${MAX_RETRIES})`;
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: action, payload: payload }) });
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            if (btn) btn.innerHTML = originalText;
            return data;
          } catch (error) {
            if (i === MAX_RETRIES - 1) { if (btn) btn.innerHTML = originalText; throw error; }
            await new Promise(r => setTimeout(r, 2000));
          }
        }
      }

      function mostrarAlerta(t,m,tp){ 
        const d=document.getElementById('modalAlerta'); 
        document.getElementById('alertaTitulo').innerText=t; 
        document.getElementById('alertaMensagem').innerHTML=m; 
        const elIcone = document.getElementById('alertaIcone'); const elTitulo = document.getElementById('alertaTitulo'); const elBtn = document.getElementById('alertaBtn');
        if(tp === 'sucesso') { elIcone.className = 'bi bi-check-circle-fill'; elIcone.style.color = 'var(--success-color)'; elTitulo.style.color = 'var(--success-color)'; elBtn.style.color = 'var(--success-color)'; elBtn.style.borderColor = 'var(--success-color)'; }
        else if (tp === 'erro') { elIcone.className = 'bi bi-exclamation-triangle-fill'; elIcone.style.color = 'var(--error-color)'; elTitulo.style.color = 'var(--error-color)'; elBtn.style.color = 'var(--error-color)'; elBtn.style.borderColor = 'var(--error-color)'; }
        else { elIcone.className = 'bi bi-info-circle-fill'; elIcone.style.color = 'var(--primary-color)'; elTitulo.style.color = 'var(--primary-color)'; elBtn.style.color = 'var(--primary-color)'; elBtn.style.borderColor = 'var(--primary-color)'; }
        d.style.display='flex'; 
      }
      
      function fecharModal(id){ document.getElementById(id).style.display='none'; }
      function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); event.currentTarget.classList.add('active'); }
      function copyTag(t) { navigator.clipboard.writeText(t); }
      function updateSlider(v) { let t=v+" di√°rias"; if(v==0.5)t="uma meia di√°ria"; else if(v==1)t="uma di√°ria"; else if(v==1.5)t="uma di√°ria e meia"; else if(v==2)t="duas di√°rias"; document.getElementById('qtdDiariasInput').value=t; }
      function setDiaria(v,t,c){ document.getElementById('qtdDiariasInput').value=t; if(!c)document.getElementById('sliderDiarias').value=v; }
      function setFormato(f) { document.getElementById('formatoInput').value=f; document.querySelectorAll('.format-option').forEach(e=>e.classList.remove('active','pdf','word')); document.getElementById(f==='pdf'?'optPdf':'optDocx').classList.add('active',f); }
      window.onload = function() { const h = new Date().toISOString().split('T')[0]; document.querySelectorAll('input[type="date"]').forEach(e=>{if(!e.value)e.value=h;}); calcularTextoAfastamento(); };
      function sincronizarAfastamento() { const i = document.getElementById('dataInicio').value; document.getElementById('afastInicio').value = i; document.getElementById('afastFim').value = document.getElementById('dataFim').value; calcularTextoAfastamento(); }
      function calcularTextoAfastamento() { const i = document.getElementById('afastInicio').value; const f = document.getElementById('afastFim').value; if(!i) return; const pt = d => d.split('-').reverse().join('/'); let t = pt(i); if(f && f!==i) t += (f < i ? "" : " a " + pt(f)); document.getElementById('dataAfastamentoHidden').value = t; document.getElementById('previewAfastamento').innerText = t; }
      function replicarDataMemo() { const d = document.getElementById('dataMemo1').value; const f = document.getElementById('formSmart'); if(f.dataMemo2) f.dataMemo2.value = d; if(f.dataMemo3) f.dataMemo3.value = d; if(f.dataMemo4) f.dataMemo4.value = d; if(f.dataDespacho) f.dataDespacho.value = d; }

      function abrirModalPerfis() {
        document.getElementById('modalPerfis').style.display = 'flex';
        const lista = document.getElementById('listaPerfis');
        lista.innerHTML = '<p style="text-align:center; color:white;"><span class="spinner-border spinner-border-sm"></span> Acedendo √† nuvem...</p>';
        apiCall('listarUsuarios').then(perfis => {
            lista.innerHTML = '';
            if (!perfis || perfis.length === 0) { lista.innerHTML = '<p style="text-align:center;">Nenhum perfil.</p>'; return; }
            perfis.forEach(p => {
              const card = document.createElement('div'); card.className = 'profile-card';
              card.onclick = () => preencherPerfil(p);
              card.innerHTML = `<div class="profile-icon"><i class="bi bi-person-fill"></i></div><div class="profile-info"><h4>${p.nome}</h4><p>${p.cargo || ''}</p></div>`;
              lista.appendChild(card);
            });
          }).catch(err => { lista.innerHTML = `<p style="color:red">Erro: ${err.message}</p>`; });
      }

      function preencherPerfil(p) { 
        document.getElementById('campoNome').value = p.nome; 
        document.getElementById('campoCargo').value = p.cargo; 
        document.getElementById('campoBanco').value = p.banco; 
        fecharModal('modalPerfis'); 
      }

      function solicitarNumeracao() {
        const btn = document.getElementById('btnAutoNum');
        const nome = document.getElementById('campoNome').value;
        const motivo = document.getElementById('campoMotivo').value;
        if(!nome || !motivo) { mostrarAlerta('Dados em Falta', 'Preencha Nome e Motivo primeiro.', 'erro'); return; }
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ...';
        btn.disabled = true;
        apiCall('solicitarNumeracao', { nome: nome, motivo: motivo }).then(res => {
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
            if(res.sucesso && res.numeros.length >= 4) {
              document.getElementById('numMemo1').value = res.numeros[0];
              document.getElementById('numMemo2').value = res.numeros[1];
              document.getElementById('numMemo3').value = res.numeros[2];
              document.getElementById('numMemo4').value = res.numeros[3];
              mostrarAlerta('Sucesso', '‚úÖ 4 N√∫meros Gerados!', 'sucesso');
            } else { mostrarAlerta('Erro', res.erro, 'erro'); }
          }).catch(err => {
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
            mostrarAlerta('Erro de Conex√£o', err.message, 'erro');
          });
      }

      function validarEProcessar(e) { 
        e.preventDefault(); 
        const form = document.getElementById('formSmart'); 
        let erro = false;
        for(let el of form.elements) { if(el.hasAttribute('required') && !el.value) { el.classList.add('input-error'); erro=true; } else { el.classList.remove('input-error'); } }
        if(erro) { mostrarAlerta('Aten√ß√£o', 'Preencha os campos obrigat√≥rios.', 'erro'); return; }
        
        const ul = document.getElementById('listaPreview'); ul.innerHTML='';
        const list = [{id:'campoNome',l:'Nome'}, {id:'campoDestino',l:'Destino'}, {id:'qtdDiariasInput',l:'Di√°rias'}, {id:'campoValor',l:'Valor'}];
        list.forEach(i => ul.innerHTML += `<li><span class="preview-label">${i.l}</span><span class="preview-value">${document.getElementById(i.id).value}</span></li>`);
        document.getElementById('modalPreview').style.display='flex';
      }

      function enviarParaBackend() {
        fecharModal('modalPreview');
        const btn = document.getElementById('btnEnviar');
        btn.disabled = true; 
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> A PROCESSAR NA NUVEM...';
        const form = document.getElementById('formSmart');
        const dados = {};
        for(let el of form.elements) { if(el.name) dados[el.name] = el.value; }

        apiCall('gerarMemorando', dados).then(res => {
            btn.disabled = false; btn.innerHTML = '<i class="bi bi-cpu"></i> PR√â-VISUALIZAR';
            if(res.sucesso) {
              const tipo = dados.formato === 'docx' ? 'Word' : 'PDF';
              mostrarAlerta('Sucesso!', `O teu arquivo <b>${tipo}</b> foi gerado. Download a iniciar...`, 'sucesso');
              const link = document.createElement("a");
              const mimeType = dados.formato === 'docx' ? 'vnd.openxmlformats-officedocument.wordprocessingml.document' : 'pdf';
              link.href = `data:application/${mimeType};base64,${res.arquivoBase64}`;
              link.download = res.nomeArquivo;
              link.click();
            } else { mostrarAlerta('Erro no Processo', res.erro, 'erro'); }
          }).catch(err => {
            btn.disabled = false; btn.innerHTML = '<i class="bi bi-cpu"></i> PR√â-VISUALIZAR';
            mostrarAlerta('Erro Fatal', 'N√£o foi poss√≠vel conectar ao servidor Google. ' + err.message, 'erro');
          });
      }
    </script>
  </body>
</html>
